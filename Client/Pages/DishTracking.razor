@using FoodCards.Client.Layouts
@using FoodCards.Client.Script
@using FoodCards.Shared
@using FoodCards.Shared.Dish
@inject DishSetUpDataService dishData
@inject NavigationManager nav

<div class="card">
    <FoodTypePie @ref=@foodTypePie />
</div>
<div class="card">
    <ul>
        <li class="li-btn" @onclick=@AddBreakfast>Breakfast</li>
        <li class="li-btn" @onclick=@AddLunch>Lunch</li>
        <li class="li-btn" @onclick=@AddDinner>Dinner</li>
        <li class="li-btn" @onclick=@AddSnacks>Snacks</li>
    </ul>
</div>
<div class="card">
    <ul>
        <li class="li-btn" @onclick="@OpenDishSetUpMenu">Goals</li>
    </ul>
    @if (chartBars.Count > 0)
    {
        <div style="margin-top: 2rem;">
            <BarChartVerticalView ChartBars=@chartBars></BarChartVerticalView>
        </div>
    }
</div>
@if (displayDishSetUp)
{
    <segment>
        <DishSetUp Refresh=@(async() => await Recalculate())></DishSetUp>
    </segment>
}
<div class="card">
    <div style="width: 10rem;height: 10rem">
        <img style ="width: 100%;height 100%" src=@($"images/glass_water.jpg") />
    </div>
</div>
<div class="card">
    <ul>
        <li class="li-btn" @onclick=@GotToDatabank>Databank</li>
    </ul>
</div>

@code {

    FoodTypePie foodTypePie;

    List<INutrition> nutritions = new();

    DishTable ingredients = new();

    List<ChartBar> chartBars = new();

    bool displayDishSetUp;

    async Task GotToDatabank()
    {
        await InvokeAsync(() =>nav.NavigateTo("/Cards"));
    }

    async Task AddBreakfast()
    {
        await InvokeAsync(() => nutritions.Add(ingredients.Ingredients[1]));
        await Recalculate();
    }

    async Task AddLunch()
    {
        await InvokeAsync(() => nutritions.Add(ingredients.Ingredients[0]));
        await Recalculate();
    }

    async Task AddDinner()
    {
        await InvokeAsync(() => nutritions.Add(ingredients.Ingredients[5]));
        await Recalculate();
    }

    async Task AddSnacks()
    {
        await InvokeAsync(() => nutritions.Add(ingredients.Ingredients[4]));
        await Recalculate();
    }

    async Task Recalculate()
    {
        var kalories = nutritions.Sum(x => x.Kalories);
        var dairy = nutritions.Where(x => x.Type == IngredientType.EggsAndDairy).Sum(x => x.Kalories);
        var meats = nutritions.Where(x => x.Type == IngredientType.MeatAndFish).Sum(x => x.Kalories);
        var carbs = nutritions.Where(x => x.Type == IngredientType.GrainsAndPotatoes).Sum(x => x.Kalories);
        var vegies = nutritions.Where(x => x.Type == IngredientType.Vegetables).Sum(x => x.Kalories);
        var fruits = nutritions.Where(x => x.Type == IngredientType.Fruits).Sum(x => x.Kalories);
        var fats = nutritions.Where(x => x.Type == IngredientType.Fats).Sum(x => x.Kalories);
        var sweets = nutritions.Where(x => x.Type == IngredientType.SweetsAndAlcohol).Sum(x => x.Kalories);
        var processed = nutritions.Where(x => x.Type == IngredientType.Processed).Sum(x => x.Kalories);

        var dairyData = Const.Get(IngredientType.EggsAndDairy);
        var meatsData = Const.Get(IngredientType.MeatAndFish);
        var carbsData = Const.Get(IngredientType.GrainsAndPotatoes);
        var vegiesData = Const.Get(IngredientType.Vegetables);
        var fruitsData = Const.Get(IngredientType.Fruits);
        var fatsData = Const.Get(IngredientType.Fats);
        var sweetsData = Const.Get(IngredientType.SweetsAndAlcohol);
        var processedData = Const.Get(IngredientType.Processed);

        await foodTypePie.Recalculate(nutritions);

        chartBars = new();
        if (dishData.DailyKalories > 0)
            chartBars.Add(new("Kalories", kalories / dishData.DailyKalories, $"{kalories}kcal"));

        var kal = kalories * 0.01m;
        if (dishData.EggsAndDairy > 0)
            chartBars.Add(new(dairyData.Name, dairy / kal / dishData.EggsAndDairy, $"{dairy}kcal"));
        if (dishData.MeatAndFish > 0)
            chartBars.Add(new(meatsData.Name, meats / kal / dishData.MeatAndFish, $"{meats}kcal"));
        if (dishData.GrainsAndPotatoes > 0)
            chartBars.Add(new(carbsData.Name, carbs / kal / dishData.GrainsAndPotatoes, $"{carbs}kcal"));
        if (dishData.Vegetables > 0)
            chartBars.Add(new(vegiesData.Name, vegies / kal / dishData.Vegetables, $"{vegies}kcal"));
        if (dishData.Fruits > 0)
            chartBars.Add(new(fruitsData.Name, fruits / kal / dishData.Fruits, $"{fruits}kcal"));
        if (dishData.Fats > 0)
            chartBars.Add(new(fatsData.Name, fats / kal / dishData.Fats, $"{fats}kcal"));
        if (dishData.SweetsAndAlcohol > 0)
            chartBars.Add(new(sweetsData.Name, sweets / kal / dishData.SweetsAndAlcohol, $"{sweets}kcal"));
        if (dishData.Processed > 0)
            chartBars.Add(new(processedData.Name, processed / kal / dishData.Processed, $"{processed}kcal"));

        await InvokeAsync(() => StateHasChanged());
    }

    async Task OpenDishSetUpMenu()
    {
        await InvokeAsync(() => displayDishSetUp = !displayDishSetUp);
    }
}

<style>
    .card {
        width: fit-content;
        height: fit-content;
    }

    .li-btn {
        padding: 0.5rem;
        border: 1px solid hsl(210, 75%, 87%);
        border-radius: 5px;
    }

    li {
        margin: 0.5rem;
    }
</style>

