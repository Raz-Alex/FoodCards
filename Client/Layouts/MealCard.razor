@using FoodCards.Client.Script
@using FoodCards.Shared
@using FoodCards.Shared.Dish

@if (Meal != null && !Hide)
{
    @if (!Compact)
    {
        <div class="card free">
            <div class="container" style=@(Meal.Ingredients.Count>0 ?"column-gap: 2rem;":"")>
                <div>
                    <label style="display: ruby-text;">
                        Name:
                        <input @bind=@Meal.Name />
                    </label>
                    <table>
                        <tbody>
                            @foreach (var ingredient in Meal.Ingredients)
                            {
                                <tr>
                                    <td>
                                        <div class="img-holder" style="width:3rem;height:3rem;margin:0">
                                            @if (!string.IsNullOrEmpty(ingredient.Photo))
                                            {
                                                <img src=@($"images/{ingredient.Photo}") />
                                            }
                                        </div>
                                    </td>
                                    <td>@ingredient.Name</td>
                                    <td>
                                        <input style="height: 1.2rem; width: 4rem;" />
                                    </td>
                                    <td>
                                        <button type="button" @onclick=@(async() => await RemoveIngredient(ingredient))
                                        style="padding-inline: 0.5rem; background-color: hsl(0, 60%, 60%); border-radius: 3px;">
                                            -
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                    <div style="margin-top:0.5rem">
                        <NutritionTable Kalories=@kalories Nutrients=@nutrients></NutritionTable>
                    </div>
                </div>
                <FoodTypePie @ref=foodTypePie />
            </div>
            <div style="width: fit-content; height: fit-content;margin: auto; margin-top: 10px;">
                <div class="button" @onclick=@(() => {if(AcceptAction != null)AcceptAction();})>
                    Accept
                </div>
                <div class="button" @onclick=@(() => {if(CancelAction != null)CancelAction();})>
                    Cancel
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="card" @onclick=@(() => {if(Click != null)Click();})>
            <h3>@Meal.Name</h3>
            <div class="img-holder" style="margin-bottom: -2rem;">
                @if (!string.IsNullOrEmpty(Meal.Photo))
                {
                    <img src=@($"images/{Meal.Photo}") />
                }
            </div>
            <FoodTypePie @ref=foodTypePie Compact=true/>
        </div>
    }
}

@code {
    [Parameter]
    public bool Compact { get; set; }

    [Parameter]
    public bool Hide { get; set; }

    [Parameter]
    public Meal Meal { get; set; }

    [Parameter]
    public Action AcceptAction { get; set; }

    [Parameter]
    public Action CancelAction { get; set; }

    [Parameter]
    public Action Click { get; set; }

    FoodTypePie foodTypePie;

    decimal kalories;

    Dictionary<string, decimal> nutrients;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if(firstRender)
            await Recalculate();
    }

    public async Task AddIngredient(FoodItem ingredient)
    {
        if (Meal.Ingredients.Contains(ingredient))
            return;

        await InvokeAsync(() => Meal.Ingredients.Add(ingredient));
        await Recalculate();
    }

    async Task RemoveIngredient(FoodItem ingredient)
    {
        await InvokeAsync(() => Meal.Ingredients.Remove(ingredient));
        await Recalculate();
    }

    async Task Recalculate()
    {
        if (foodTypePie == null)
            return;

        await foodTypePie.Recalculate(Meal.Ingredients);
        await InvokeAsync(() =>
        {
            kalories = foodTypePie.Kalories;
            nutrients = new()
            {
                {"Protein", Meal.Ingredients.Sum(x => x.Protein)},
                {"Fat",Meal.Ingredients.Sum(x => x.Fat)},
                {"Sat. Fat",Meal.Ingredients.Sum(x => x.SaturatedFat)},
                {"Carbs",Meal.Ingredients.Sum(x => x.Carbohydrate)},
                {"Sugar",Meal.Ingredients.Sum(x => x.Sugar)},
                {"Salt",Meal.Ingredients.Sum(x => x.Salt)},
                {"Fiber",Meal.Ingredients.Sum(x => x.Fiber)}
            };
            StateHasChanged();
        });
    }
}

<style>
    .container{
        display: grid;
        grid-template-columns: auto auto;
    }
</style>
